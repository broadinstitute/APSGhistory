#!/util/bin/perl -w

use POSIX qw(strftime);

my %skip = {'/seq/solexaproc'   => 1,
            '/seq/solexaproc01' => 1,
            '/seq/solexaproc05' => 1,
            '/broad/solexaproc' => 1,
            '/seq/dirseq'       => 1,
            '/slxa/migration'   => 1,
            '/broad/newdata'    => 1,
           };
##
## Get list of filesystems to look at
##
my @maps;
my $cmd = "ypcat auto.master | awk '{print \$1}'";
open(CMD, "$cmd |") or die "Unable to run $cmd: $!\n";
while (<CMD>) {
	chomp;
	push @maps, $_
}

for my $map (@maps) {
  $cmd = "ypcat -k $map | awk '{print \$1}'";
  ($dir = $map) =~ s/auto\.//;
  open(CMD, "$cmd |") or die "Unable to run $cmd: $!\n";
  while (<CMD>) {
	chomp;
        my $mount = "/$dir/$_";
	push @filesys, $mount unless defined $skip{$mount};
  }
}

my $when = strftime "%Y%m%d", localtime;

exit;

foreach my $filesys (sort @filesys) {

	my ($path,$blks,$used,$avail,$cap,$mount);

	my $df = "df -k $filesys | tr -d % | tail +2";
        my $line;
        eval {
          local $SIG{ALRM} = sub {die "alarm"};
          alarm 20;
	  open DF, "$df | "  or die "Unable to run $df: $!\n";
	  $line = join " ", <DF>;
          chomp $line;
          close DF;
          alarm 0;
        };
        if ($@) {
          die $@ unless $@ eq "alarm";
          print STDERR "df of $filesys timed out. Skipping.\n";
          next;
        }
	($path,$blks,$used,$avail,$cap,$mount) = split /\s+/, $line;
        print STDERR "skipping $filesys\n" and next unless $path;
        my $key  = $mount . "::" . $path;
        if ($key =~ /automount/) {
          warn "Here: $filesys $key ($line)";
          sleep 10;
          next;
        }
        my $fsid = defined $fsid{$key} ? $fsid{$key} 
                                       : getfsid($dbh, $mount, $path);
        die "unknown fsid" unless $fsid;
        print STDERR "$fsid: $path [$mount]\n";
        my $sql = "INSERT INTO fsusage(fsid,checked,blocks,used,available,capacity) VALUES ($fsid,$when,$blks,$used,$avail,$cap)";
        $dbh->do($sql);
	sleep 7;
}

exit;

sub getfsid {
  my $dbh   = shift;
  my $mount = shift;
  my $path  = shift;

  my $sql = qq{SELECT id FROM filesystem where mount="$mount" and path="$path"};
  my $sth = $dbh->prepare($sql);

  $sth->execute;
  if ($sth->rows) {
    my $ref = $sth->fetchrow_hashref();
    return $ref->{'id'};
  }
  $sql = sprintf("INSERT INTO filesystem (mount, path) VALUES (%s, %s)",
                 $dbh->quote($mount), $dbh->quote($path));
  $dbh->do($sql);
  return getfsid($dbh,$mount,$path);
}
