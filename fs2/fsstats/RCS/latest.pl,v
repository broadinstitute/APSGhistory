head	1.1;
access;
symbols;
locks
	matter:1.1; strict;
comment	@# @;


1.1
date	2009.06.30.01.22.45;	author matter;	state Exp;
branches;
next	;


desc
@Sanitize the 'latest' column in fsstat.
@


1.1
log
@Initial revision
@
text
@#!/util/bin/perl -w

use DBI;
use DBD::mysql;

##
## Initiate DB connection
##
my $dsn = "DBI:mysql:database=matter;host=mysql;port=3306";
my $dbh = DBI->connect($dsn, "matter", "spamLet1");

my $sql = <<SQL;
select fsid, dirid, checked, latest 
from fsstat 
where uid is null
and type=2
order by fsid,dirid,checked desc
SQL

my $sth = $dbh->prepare($sql);

my $nr = $sth->execute();
print STDERR "Found $nr rows\n";
my $n = 0;
my $fsid = -1;
my $dirid = -1;
while (my @@r = $sth->fetchrow_array()) {
#    print "There: $fsid, $dirid, @@r\n";
  unless ($r[0] == $fsid and $r[1] == $dirid) {
    if ($r[3] == 1) {
      $fsid = $r[0];
      $dirid = $r[1];
      next;
    }
    print "Here: $fsid, $dirid, @@r\n";
    $sql = "update fsstat set latest=0 where fsid=$r[0] and dirid=$r[1] and checked < $r[2]";
    print "$sql\n";
#    $dbh->do($sql);
    $sql = "update fsstat set latest=1 where fsid=$r[0] and dirid=$r[1] and checked = $r[2]";
    print "$sql\n";
#    $dbh->do($sql);
  }
  $fsid = $r[0];
  $dirid = $r[1];
}
@
